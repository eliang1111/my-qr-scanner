<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner to Google Sheet</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; }
        #qr-reader { width: 500px; max-width: 90%; margin: 20px auto; border: 1px solid #ccc; }
        #result, #loading, #error { margin-top: 20px; font-size: 1.2em; }
        #loading { display: none; color: blue; }
        #result { color: green; }
        #error { color: red; }
        input, button { padding: 10px; font-size: 1em; margin: 5px; }
    </style>
</head>
<body>

    <h1>สแกน QR Code ส่งเข้า Google Sheet</h1>

    <p>วางลิงก์ Web App URL ที่ได้จาก Google Apps Script:</p>
    <input type="url" id="appsScriptUrl" placeholder="วางลิงก์ Web App URL ที่นี่" size="50">
    <br>
    <button id="startScanBtn">กดเพื่อเริ่มสแกน</button>

    <div id="qr-reader"></div>

    <div id="loading">กำลังส่งข้อมูล...</div>
    <div id="result"></div>
    <div id="error"></div>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        const startScanBtn = document.getElementById('startScanBtn');
        const appsScriptUrlInput = document.getElementById('appsScriptUrl');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const qrReaderDivId = "qr-reader";

        let html5QrCode;

        // ฟังก์ชันเมื่อสแกนสำเร็จ
        async function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);
            
            // หยุดการสแกน
            html5QrCode.stop().then(() => {
                console.log("QR Code scanning stopped.");
                document.getElementById(qrReaderDivId).style.display = 'none';
            }).catch(err => {
                console.error("Failed to stop scanning.", err);
            });

            // แสดงสถานะกำลังส่ง
            loadingDiv.style.display = 'block';
            resultDiv.innerText = '';
            errorDiv.innerText = '';

            const webAppUrl = appsScriptUrlInput.value;
            if (!webAppUrl) {
                errorDiv.innerText = "กรุณาใส่ Web App URL ก่อนครับ";
                loadingDiv.style.display = 'none';
                return;
            }

            // ส่งข้อมูลไปที่ Google Apps Script
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors', //  สำคัญ: ใช้ no-cors เพราะ Apps Script ไม่ได้ตั้งค่า CORS
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ qrData: decodedText })
                });

                loadingDiv.style.display = 'none';
                resultDiv.innerText = `ส่งข้อมูล "${decodedText}" สำเร็จ!`;

            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.innerText = `เกิดข้อผิดพลาดในการส่งข้อมูล: ${error}`;
            }
        }

        // ฟังก์ชันเมื่อสแกนไม่สำเร็จ
        function onScanFailure(error) {
            // console.warn(`QR error = ${error}`);
        }

        // เมื่อกดปุ่มเริ่มสแกน
        startScanBtn.addEventListener('click', () => {
            if (!appsScriptUrlInput.value) {
                alert("กรุณาใส่ Web App URL ก่อนครับ");
                return;
            }
            
            resultDiv.innerText = '';
            errorDiv.innerText = '';
            document.getElementById(qrReaderDivId).style.display = 'block';

            html5QrCode = new Html5Qrcode(qrReaderDivId);
            html5QrCode.start(
                { facingMode: "environment" }, // ใช้กล้องหลัง
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 } 
                },
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                errorDiv.innerText = `ไม่สามารถเปิดกล้องได้: ${err}`;
            });
        });
    </script>

</body>
</html>